## 常见索引类型

| 索引类型                | 全称                                        | 精度        | 查询速度        | 存储开销                 | 训练成本          | 支持增删？   | 适用场景                          |
| ------------------- | ----------------------------------------- | --------- | ----------- | -------------------- | ------------- | ------- | ----------------------------- |
| **`IndexFlatL2`**   | Flat (Brute-force) + L2                   | ✅ 精确      | ❌ 慢（O(n)）   | 高（4d 字节/向量）          | 无             | ✅（动态添加） | 小规模（<10⁴），需严格精度（如评测 baseline） |
| **`IndexFlatIP`**   | Flat + Inner Product                      | ✅ 精确      | ❌ 慢         | 同上                   | 无             | ✅       | 同上，用于余弦相似度（embedding 已归一化）    |
| **`IndexIVFFlat`**  | Inverted File + Flat                      | ⚠️ 近似（可控） | ✅ 较快（仅搜部分簇） | 中（+ `nlist × d` 簇中心） | 中（k-means 聚类） | ✅（部分支持） | 中规模（10⁴ ~ 10⁶），精度要求较高         |
| **`IndexIVFPQ`**    | IVF + Product Quantization                | ⚠️ 近似     | ✅✅ 快        | 🔽 低（如 8~32 字节/向量）   | 高（PQ 训练）      | ❌（通常只读） | 大规模（>10⁶），内存/存储受限             |
| **`IndexHNSWFlat`** | Hierarchical Navigable Small World + Flat | ⚠️ 高精度近似  | ✅✅ 快（图遍历）   | 中高（图边存储）             | 中             | ❌       | 高精度+高吞吐场景（如推荐召回）              |
| **`IndexLSH`**      | Locality-Sensitive Hashing                | ❌ 低精度     | ✅ 快（哈希桶查）   | 低                    | 低             | ✅       | 超大规模初筛、去重、快速过滤                |

## Faiss

### 1. `IndexFlatL2` / `IndexFlatIP`

- **原理**：暴力计算 query 与所有库向量的距离。

```python
import faiss
index = faiss.IndexFlatL2(d)          # d: 向量维度
index.add(vectors)                    # vectors: (n, d) np.float32
D, I = index.search(query, k=5)       # D: distances, I: indices
```
![](https://raw.githubusercontent.com/marqu22/image_home/main/main_1060/20251216125746015.png)

**推导过程**

![image.png](https://raw.githubusercontent.com/marqu22/image_home/main/main_1060/20251216130431347.png)

![](https://raw.githubusercontent.com/marqu22/image_home/main/main_1060/20251216130745443.png)

### 2. **`IndexIVFFlat`**

- **`IVF`**：**Inverted File（倒排索引）** 的缩写 —— 这是核心加速机制！
    - 先用聚类（如 k-means）将向量空间划分为 `nlist` 个簇（Voronoi 单元）；
    - 每个向量归属到最近的簇（即“倒排列表”）；
    - 查询时只搜索最近的 `nprobe` 个簇，大幅减少比对量。
- **`Flat`**：在每个被选中的簇内部，**仍用原始向量做精确（flat）比对**（即不量化）

### 3. **`IndexIVFPQ`**

- **`IVF`**：同上，使用倒排索引做粗粒度过滤（先选 `nprobe` 个簇）。
- **`PQ`**：**Product Quantization（乘积量化）** —— 一种**有损压缩技术**：
    - 将高维向量分段（如 128 维 → 8 段 × 16 维）；
    - 每段独立聚类，用聚类中心 ID（如 8 bit = 256 个码字）**编码**该段；
    - 最终每个向量用一串短码（如 8 字节）近似表示，极大节省存储；
    - 查询时用不对称距离估算（ADC）快速近似计算距离。
### 4. `IndexHNSW`

- **原理**：基于图的 ANN 方法（Hierarchical Navigable Small World）：
    - 构建多层跳表式近邻图；
    - 搜索时从顶层粗略定位，逐层细化。
- **关键参数**：
    - `M`：每个节点的最大连接数（越大图越密，精度↑内存↑，常用 8~64）
    - `efConstruction`：建图时动态候选集大小（影响建图质量，常用 80~200）
    - `efSearch`：查询时动态候选集大小（影响 query 精度/速度，默认 20；可动态设 `index.hnsw.efSearch = 50`）

![](https://raw.githubusercontent.com/marqu22/image_home/main/main_1060/20251216135544765.png)

在可导航小世界图（Navigable Small World Graphs，简称NSW）中，搜索过程通过一种称为贪婪路由的方法实现，这种方法通过逐步优化来逼近目标顶点。具体步骤如下：

1. **贪婪路由搜索**：从任意顶点开始，识别朋友列表中与查询向量最近的相邻顶点，然后转移到该顶点。这个过程重复进行，直到找到一个局部最小值，即当前顶点比之前访问的任何顶点都更接近查询向量，此时停止搜索。
2. **局部最小值作为停止条件**：当搜索达到一个局部最小值时，认为已经找到了足够接近查询向量的顶点，从而结束搜索过程。
3. **网络的可导航性定义**：NSW图被定义为能够在多项式或对数时间复杂度内，通过贪婪路由有效搜索的网络结构。
4. **贪婪路由的效率问题**：在大型网络（顶点数量在1到10K以上）中，如果图的结构不可导航，贪婪路由的效率可能会显著下降。
5. **路由的两个阶段**：
    - **缩小阶段**：在搜索初期，优先通过度数较低的顶点进行路由，这有助于快速缩小搜索范围。
    - **放大阶段**：随着搜索的深入，逐渐转向度数较高的顶点进行路由，这有助于在局部区域内进行更细致的搜索。
### 5. `IndexLSH`（Locality-Sensitive Hashing）

#### 🔹 原理简述

- **核心思想**：设计一种哈希函数族，使得**相似向量以高概率落入同一桶（bucket）中**。
- Faiss 实现的是 **随机投影 LSH（基于 p-stable 分布）**，适用于 `L2` 距离。
![image.png](https://raw.githubusercontent.com/marqu22/image_home/main/main_1060/20251216135940232.png)

- 查询时：仅在 **与 query 哈希值相同的桶内** 进行暴力比对（Flat search）。